defmodule Day17 do

  import Intcode, only: [runner: 3, read_program: 1]

  "
..............#####............................
..............#...#............................
..............#...#............................
..............#...#............................
..............#...#............................
..............#...#............................
..............#...#.....#############..........
..............#...#.....#...........#..........
..............#.#####...#.#############........
..............#.#.#.#...#.#.........#.#........
..............#.#.#############.....#.#........
..............#.#...#...#.#...#.....#.#........
..............#######...#.#.###########........
................#.......#.#.#.#.....#..........
........#########.......#.#####.....#####......
........#...............#...#...........#......
........#...............#...#...........#......
........#...............#...#...........#......
#########.....###########...#...........#......
#.............#.............#...........#......
#.............#.........#######.........#......
#.............#.........#...#.#.........#......
#.............#############.#.#.........######^
#.......................#.#.#.#................
#.......................#####.#................
#.........................#...#................
#.........................#...#................
#.........................#...#................
#.........................#...#................
#.........................#...#................
#######...................#...#................
......#...................#...#................
......#...................#####................
......#........................................
......#........................................
......#........................................
......#........................................
......#........................................
......#####....................................
..........#....................................
..........#....................................
..........#....................................
..........#....................................
..........#....................................
..........#....................................
..........#....................................
..........#############........................
  "

  def get_progr do
    read_program("day17.txt")

  end

  def get_map do
    {map, progr} = runner(get_progr, 0, input: [])
    map
  end

  def print_map do
    IO.puts(get_map)
  end

  def map_to_map do
    get_map |> List.to_string() |> String.split("\n") |> Enum.map( &String.graphemes/1) |> Enum.filter(&(Enum.count(&1)>0))
    |> Enum.with_index |> Enum.reduce(%{}, fn {v, y}, accy ->
      v |> Enum.with_index() |> Enum.reduce(accy, fn {v, x}, accx ->
        Map.put(accx, {x, y}, v)
      end)
    end)
  end

  def is_intersection({x,y}, map) do
    p1 = {x-1, y}
    p2 = {x+1, y}
    p3 = {x, y-1}
    p4 = {x, y+1}

    Map.get(map, p1) == "#" && Map.get(map, p2) == "#" && Map.get(map, p3) == "#" && Map.get(map, p4) == "#"
  end

  def get_intersections(map) do
    map_to_map |> Enum.filter( fn {{x,y}, w} ->
      if w == "#", do: is_intersection({x,y}, map)
    end)
  end

  def part1 do
    get_intersections(map_to_map) |> Enum.map(fn {{x, y}, "#"} ->
      x*y
    end) |> Enum.sum
  end

end
